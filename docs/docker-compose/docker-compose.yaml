# æ›´å¤šéƒ¨ç½²æ–¹å¼è¯¦è§ï¼šhttp://ldapdoc.eryajf.net/pages/f081dc/
version: '3'

networks:
  go-ldap-admin:
    driver: bridge

services:
  go-ldap-admin:
    image: registry.cn-hangzhou.aliyuncs.com/eryajf/go-ldap-admin
    container_name: go-ldap-admin
    hostname: go-ldap-admin
    restart: always
    environment:
      WAIT_HOSTS: openldap:389
    configs:
      - source: go_ldap_admin_config
        target: /app/config.yml
    ports:
      - 8888:8888
    volumes:
      - ./data/go-ldap-admin:/app/data
    depends_on:
      - openldap
    links:
      - openldap:go-ldap-admin-openldap
    networks:
      - go-ldap-admin

  openldap:
    image: registry.cn-hangzhou.aliyuncs.com/eryajf/openldap:1.4.1
    container_name: go-ldap-admin-openldap
    hostname: go-ldap-admin-openldap
    restart: always
    environment:
      TZ: Asia/Shanghai
      LDAP_ORGANISATION: "eryajf.net"
      LDAP_DOMAIN: "eryajf.net"
      LDAP_ADMIN_PASSWORD: "123456"
    command: [ '--copy-service' ]
    volumes:
      - ./data/openldap/database:/var/lib/ldap
      - ./data/openldap/config:/etc/ldap/slapd.d
    ports:
      - 389:389
    networks:
      - go-ldap-admin

configs:
  go_ldap_admin_config:
    content: |
      # delelopment
      system:
        # è®¾å®šæ¨¡å¼(debug/release/test,æ­£å¼ç‰ˆæ”¹ä¸ºrelease)
        mode: debug
        # urlå‰ç¼€
        url-path-prefix: api
        # ç¨‹åºç›‘å¬ç«¯å£
        port: 8888
        # æ˜¯å¦åˆå§‹åŒ–æ•°æ®(æ²¡æœ‰åˆå§‹æ•°æ®æ—¶ä½¿ç”¨, å·²å‘å¸ƒæ­£å¼ç‰ˆæ”¹ä¸ºfalse)
        init-data: true
      logs:
        # æ—¥å¿—ç­‰çº§(-1:Debug, 0:Info, 1:Warn, 2:Error, 3:DPanic, 4:Panic, 5:Fatal, -1<=level<=5, å‚ç…§zap.levelæºç )
        level: -1
        # æ—¥å¿—è·¯å¾„
        path: data/logs
        # æ–‡ä»¶æœ€å¤§å¤§å°, M
        max-size: 50
        # å¤‡ä»½æ•°
        max-backups: 100
        # å­˜æ”¾æ—¶é—´, å¤©
        max-age: 30
        # æ˜¯å¦å‹ç¼©
        compress: false
      database:
        # æ•°æ®åº“ç±»å‹ mysql sqlite3
        driver: sqlite3
        # æ•°æ®åº“è¿æ¥sqlite3æ•°æ®æ–‡ä»¶çš„è·¯å¾„
        source: data/go-ldap-admin.db
      mysql:
        # ç”¨æˆ·å
        username: root
        # å¯†ç 
        password: 123456
        # æ•°æ®åº“å
        database: go_ldap_admin
        # ä¸»æœºåœ°å€
        host: localhost
        # ç«¯å£
        port: 3306
        # è¿æ¥å­—ç¬¦ä¸²å‚æ•°
        query: parseTime=True&loc=Local&timeout=10000ms
        # æ˜¯å¦æ‰“å°æ—¥å¿—
        log-mode: true
        # æ•°æ®åº“è¡¨å‰ç¼€(æ— éœ€å†æœ«å°¾æ·»åŠ ä¸‹åˆ’çº¿, ç¨‹åºå†…éƒ¨è‡ªåŠ¨å¤„ç†)
        table-prefix: tb
        # ç¼–ç æ–¹å¼
        charset: utf8mb4
        # å­—ç¬¦é›†(utf8mb4_general_cié€Ÿåº¦æ¯”utf8mb4_unicode_ciå¿«äº›)
        collation: utf8mb4_general_ci
      # jwté…ç½®
      jwt:
        # jwtæ ‡è¯†
        realm: test jwt
        # æœåŠ¡ç«¯å¯†é’¥
        key: secret key
        # tokenè¿‡æœŸæ—¶é—´, å°æ—¶
        timeout: 12000
        # åˆ·æ–°tokenæœ€å¤§è¿‡æœŸæ—¶é—´, å°æ—¶
        max-refresh: 12000
      # ä»¤ç‰Œæ¡¶é™æµé…ç½®
      rate-limit:
        # å¡«å……ä¸€ä¸ªä»¤ç‰Œéœ€è¦çš„æ—¶é—´é—´éš”,æ¯«ç§’
        fill-interval: 50
        # æ¡¶å®¹é‡
        capacity: 200
      # email configuration
      email:
        port: '465'
        user: 'eryajf@163.com'
        from: 'go-ldap-adminåå°'
        host: 'smtp.163.com'
        # is-ssl: true
        pass: 'your password'
      # # ldap é…ç½®
      ldap:
        # ldapæœåŠ¡å™¨åœ°å€
        url: ldap://openldap:389
        # ladpæœ€å¤§è¿æ¥æ•°è®¾ç½®
        max-conn: 10
        # ldapæœåŠ¡å™¨åŸºç¡€DN
        base-dn: "dc=eryajf,dc=net"
        # ldapç®¡ç†å‘˜DN
        admin-dn: "cn=admin,dc=eryajf,dc=net"
        # ldapç®¡ç†å‘˜å¯†ç 
        admin-pass: "123456"
        # ldapç”¨æˆ·OU
        user-dn: "ou=people,dc=eryajf,dc=net"
        # ldapç”¨æˆ·åˆå§‹é»˜è®¤å¯†ç 
        user-init-password: "123456"
        # æ˜¯å¦å…è®¸æ›´æ”¹åˆ†ç»„DN
        group-name-modify: false
        # æ˜¯å¦å…è®¸æ›´æ”¹ç”¨æˆ·DN
        user-name-modify: false
        # ç”¨æˆ·å¯†ç åŠ å¯†æ–¹å¼ é»˜è®¤ä¸º ssha è¿˜å¯æŒ‡å®šä¸º clear(è¡¨ç¤ºä¸åŠ å¯†)
        user-password-encryption-type: "ssha"
        # é»˜è®¤é‚®ç®±åç¼€
        default-email-suffix: "eryajf.net"
      # ğŸ“¢ å³ä¾¿ç”¨ä¸åˆ°å¦‚ä¸‹ä¸‰æ®µé…ç½®ä¿¡æ¯ï¼Œä¹Ÿä¸è¦åˆ é™¤ï¼Œå¦åˆ™ä¼šæœ‰ä¸€äº›å¥‡æ€ªçš„é”™è¯¯å‡ºç°
      dingtalk:
        # é…ç½®è·å–è¯¦ç»†æ–‡æ¡£å‚è€ƒï¼š http://ldapdoc.eryajf.net/pages/94f43a/
        flag: "dingtalk" # ä½œä¸ºé’‰é’‰åœ¨å¹³å°çš„æ ‡è¯†
        app-key: "xxxxxxxxxxxxxxx" # åº”ç”¨çš„key
        app-secret: "xxxxxxxxxxxxxxxxxxxxxxxxxxxx" # åº”ç”¨çš„secret
        agent-id: "12121212" # ç›®å‰agent-idæœªä½¿ç”¨åˆ°ï¼Œå¯å¿½ç•¥
        enable-sync: false  # æ˜¯å¦å¼€å¯å®šæ—¶åŒæ­¥é’‰é’‰çš„ä»»åŠ¡
        dept-sync-time: "0 30 2 * * *" # éƒ¨é—¨åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹
        user-sync-time: "0 30 3 * * *" # ç”¨æˆ·åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹,æ³¨æ„è¯·æŠŠç”¨æˆ·åŒæ­¥çš„ä»»åŠ¡æ»åäºéƒ¨é—¨åŒæ­¥æ—¶é—´,æ¯”å¦‚éƒ¨é—¨ä¸º2ç‚¹,åˆ™ç”¨æˆ·ä¸º3ç‚¹
        dept-list:    # é…ç½®è¦åŒæ­¥çš„éƒ¨é—¨åˆ—è¡¨ï¼Œé…ç½®ç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰éƒ¨é—¨ï¼Œåœ¨å¼€å¤´åŠ ^è¡¨ç¤ºä¸åŒæ­¥æ­¤éƒ¨é—¨
          #- "48456726"   # éœ€è¦åŒæ­¥çš„éƒ¨é—¨ID
          #- "^61213417"  # ä¸éœ€è¦åŒæ­¥çš„éƒ¨é—¨ID
        is-update-syncd: false # å½“é’‰é’‰ç”¨æˆ·çš„é‚®ç®±ï¼Œæ‰‹æœºå·ï¼Œéƒ¨é—¨ç­‰ä¿¡æ¯æ›´æ–°ä¹‹åï¼Œæ˜¯å¦åŒæ­¥æ›´æ–°ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœä½ ä¸äº†è§£è¿™ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œåˆ™ä¸å»ºè®®å¼€å¯
        user-leave-range: 0 #æŒ‰é…ç½®å¤©æ•°æŸ¥ç¦»èŒæ—¶é—´èŒƒå›´å†…çš„ç”¨æˆ·,ä¸º0æ—¶ä¸é™åˆ¶
      wecom:
        # é…ç½®è·å–è¯¦ç»†æ–‡æ¡£å‚è€ƒï¼šhttp://ldapdoc.eryajf.net/pages/cf1698/
        flag: "wecom" # ä½œä¸ºå¾®ä¿¡åœ¨å¹³å°çš„æ ‡è¯†
        corp-id: "xxxx" # ä¼ä¸šå¾®ä¿¡ä¼ä¸šID
        agent-id: 1000003 # ä¼ä¸šå¾®ä¿¡ä¸­åˆ›å»ºçš„åº”ç”¨ID
        corp-secret: "xxxxx" # ä¼ä¸šå¾®ä¿¡ä¸­åˆ›å»ºçš„åº”ç”¨secret
        enable-sync: false # æ˜¯å¦å¼€å¯å®šæ—¶åŒæ­¥ä¼ä¸šå¾®ä¿¡çš„ä»»åŠ¡
        dept-sync-time: "0 30 2 * * *" # éƒ¨é—¨åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹
        user-sync-time: "0 30 3 * * *" # ç”¨æˆ·åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹,æ³¨æ„è¯·æŠŠç”¨æˆ·åŒæ­¥çš„ä»»åŠ¡æ»åäºéƒ¨é—¨åŒæ­¥æ—¶é—´,æ¯”å¦‚éƒ¨é—¨ä¸º2ç‚¹,åˆ™ç”¨æˆ·ä¸º3ç‚¹
        is-update-syncd: false # å½“ä¼å¾®ç”¨æˆ·çš„é‚®ç®±ï¼Œæ‰‹æœºå·ï¼Œéƒ¨é—¨ç­‰ä¿¡æ¯æ›´æ–°ä¹‹åï¼Œæ˜¯å¦åŒæ­¥æ›´æ–°ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœä½ ä¸äº†è§£è¿™ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œåˆ™ä¸å»ºè®®å¼€å¯
      feishu:
        # é…ç½®è·å–è¯¦ç»†æ–‡æ¡£å‚è€ƒï¼šhttp://ldapdoc.eryajf.net/pages/83c90b/
        flag: "feishu" # ä½œä¸ºé£ä¹¦åœ¨å¹³å°çš„æ ‡è¯†
        app-id: "xxxxxxx" # é£ä¹¦çš„app-id
        app-secret: "xxxxxxxxxxx" # é£ä¹¦çš„app-secret
        enable-sync: false  # æ˜¯å¦å¼€å¯å®šæ—¶åŒæ­¥é£ä¹¦çš„ä»»åŠ¡
        dept-sync-time: "0 20 0 * * *" # éƒ¨é—¨åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹
        user-sync-time: "0 40 0 * * *" # ç”¨æˆ·åŒæ­¥ä»»åŠ¡çš„æ—¶é—´ç‚¹ * * * * * * ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨, è¯·æŠŠæ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨ 1 ~ 5 ç‚¹,æ³¨æ„è¯·æŠŠç”¨æˆ·åŒæ­¥çš„ä»»åŠ¡æ»åäºéƒ¨é—¨åŒæ­¥æ—¶é—´,æ¯”å¦‚éƒ¨é—¨ä¸º2ç‚¹,åˆ™ç”¨æˆ·ä¸º3ç‚¹
        dept-list:    # é…ç½®è¦åŒæ­¥çš„éƒ¨é—¨åˆ—è¡¨ï¼Œé…ç½®ç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰éƒ¨é—¨ï¼Œåœ¨å¼€å¤´åŠ ^è¡¨ç¤ºä¸åŒæ­¥æ­¤éƒ¨é—¨
          #- "48456726"   # éœ€è¦åŒæ­¥çš„éƒ¨é—¨ID
          #- "^61213417"  # ä¸éœ€è¦åŒæ­¥çš„éƒ¨é—¨ID
        is-update-syncd: false # å½“é£ä¹¦ç”¨æˆ·çš„é‚®ç®±ï¼Œæ‰‹æœºå·ï¼Œéƒ¨é—¨ç­‰ä¿¡æ¯æ›´æ–°ä¹‹åï¼Œæ˜¯å¦åŒæ­¥æ›´æ–°ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœä½ ä¸äº†è§£è¿™ä¸ªå­—æ®µçš„å«ä¹‰ï¼Œåˆ™ä¸å»ºè®®å¼€å¯